parameters:
  SOMWorkspaceID: '9aee72fc-a4e1-4f86-8343-8bcb69b03955'
  # ComplianceBranch: 'refs/heads/mrtk_development'
  ComplianceBranch: 'refs/heads/user/maboro/compliance'

steps:
# the following tasks should only be run on mrtk_development branch, otherwise we risk issue being reported multiple times on topic/release branches
- task: PoliCheck@1
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], ${{ parameters.ComplianceBranch }}))
  inputs:
    inputType: 'Basic'
    targetType: 'F'
    targetArgument: '$(Build.SourcesDirectory)'
    result: 'PoliCheck.xml'
    optionsUEPATH: '$(Build.SourcesDirectory)\pipelines\config\PolicheckUserExclusion.xml'
    SOMEnabled: true
    uploadToSOM: true
    workspaceId: '${{ parameters.SOMWorkspaceID }}'
    uploadErrorLevel: 'Error'

- task: CredScan@2
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], ${{ parameters.ComplianceBranch }}))
  inputs:
    toolMajorVersion: 'V2'
    # suppressionsFile: '$(Build.SourcesDirectory)\pipelines\config\CredScanSuppressions.json'

- task: BinSkim@3
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], ${{ parameters.ComplianceBranch }}))
  inputs:
    InputType: 'Basic'
    Function: 'analyze'
    AnalyzeTarget: 'Microsoft.MixedReality.Toolkit.*.dll'
    AnalyzeSymPath: '$(Build.SourcesDirectory)'
    AnalyzeRecurse: true
    toolVersion: '1.4.5'

- task: RoslynAnalyzers@2
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], ${{ parameters.ComplianceBranch }}))
  inputs:
      userProvideBuildInfo: 'auto'

- task: PublishSecurityAnalysisLogs@2
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], ${{ parameters.ComplianceBranch }}))
  inputs:
    ArtifactName: 'CodeAnalysisLogs'
    ArtifactType: 'Container'

- task: PostAnalysis@1
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], ${{ parameters.ComplianceBranch }}))
  inputs:
    AllTools: false
    APIScan: false
    BinSkim: true
    CodesignValidation: false
    CredScan: true
    FortifySCA: false
    FxCop: false
    ModernCop: false
    PoliCheck: true
    PoliCheckBreakOn: 'Severity4Above'
    RoslynAnalyzers: true
    SDLNativeRules: false
    Semmle: false
    TSLint: false
    ToolLogsNotFoundAction: 'Standard'
